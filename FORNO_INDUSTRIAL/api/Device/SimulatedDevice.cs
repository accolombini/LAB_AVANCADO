using Forno.Api.Device;
public sealed class SimulatedDevice:IDevice{private bool run;private Telemetry? last;private double T=25,SP=180,LMin=120,LMax=220,LCrit=240;private string Mode="AUTO",State="IDLE",Alarm="NONE";private int Heater=0,Fan=0;private bool Estop=false;public Telemetry? LastTelemetry=>last;public System.Threading.Tasks.Task StartAsync(System.Threading.CancellationToken ct=default){run=true;_=_loop(ct);return System.Threading.Tasks.Task.CompletedTask;}private async System.Threading.Tasks.Task _loop(System.Threading.CancellationToken ct){while(run){var heat=Heater/255.0*3.0;var cool=Fan/255.0*2.0;T+=heat-cool-0.05;if(!Estop&&Mode=="AUTO"){if(T<SP-2){State="HEATING";Heater=200;Fan=0;}else if(T>SP+2){State="COOLING";Heater=0;Fan=180;}else{State="IDLE";Heater=0;Fan=0;}}if(T>=LCrit){State="CRITICAL";Heater=0;Fan=255;Alarm="ON";}else Alarm="NONE";last=new Telemetry(T,SP,LMin,LMax,LCrit,Mode,State,Heater,Fan,Alarm,Estop,Estop?200:0,1500,System.DateTime.UtcNow);await System.Threading.Tasks.Task.Delay(100,ct);} }public System.Threading.Tasks.Task StopAsync(System.Threading.CancellationToken ct=default){run=false;return System.Threading.Tasks.Task.CompletedTask;}public System.Threading.Tasks.Task<string> SendAsync(string s,System.Threading.CancellationToken ct=default){s=s.Trim().ToUpperInvariant();if(s=="GET;")return System.Threading.Tasks.Task.FromResult("ACK;");if(s=="START;"){Estop=false;return System.Threading.Tasks.Task.FromResult("ACK;");}if(s=="STOP;"){Heater=0;Fan=255;return System.Threading.Tasks.Task.FromResult("ACK;");}if(s=="RST_ESTOP;"){Estop=false;return System.Threading.Tasks.Task.FromResult("ACK;");}if(s.StartsWith("MODE=")){Mode=s.Contains("AUTO")?"AUTO":"MAN";return System.Threading.Tasks.Task.FromResult("ACK;");}if(s.StartsWith("SET_SP=")){SP=double.Parse(s[7..].TrimEnd(';'));return System.Threading.Tasks.Task.FromResult("ACK;");}if(s.StartsWith("SET_LIMS=")){var v=s[9..].TrimEnd(';').Split(',');LMin=double.Parse(v[0]);LMax=double.Parse(v[1]);LCrit=double.Parse(v[2]);return System.Threading.Tasks.Task.FromResult("ACK;");}if(s.StartsWith("MAN=")){var v=s[4..].TrimEnd(';').Split(',');Mode="MAN";Heater=int.Parse(v[0]);Fan=int.Parse(v[1]);return System.Threading.Tasks.Task.FromResult("ACK;");}return System.Threading.Tasks.Task.FromResult("ERR=CMD;");}}
